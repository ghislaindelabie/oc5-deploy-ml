name: Database Integration Tests

# Only run database tests on PRs to main branch
on:
  pull_request:
    branches: ["main"]

jobs:
  database-tests:
    name: Test database integration with Supabase
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install heavy scientific stack
        run: |
          python -m pip install --upgrade pip
          pip install "numpy==2.3.*" "pandas==2.2.*" "scikit-learn==1.5.*"

      - name: Install uv and pytest
        run: pip install uv pytest pytest-cov pytest-asyncio httpx

      - name: Install dependencies + dev groups
        run: |
          uv export --format requirements-txt --group dev \
          | grep -vE '^-e[[:space:]]+\.$' \
          | uv pip sync --system -

      - name: Install project (editable)
        run: python -m pip install -e .

      - name: Run database integration tests
        env:
          OC5_DATABASE_URL: ${{ secrets.OC5_DATABASE_URL }}
          APP_ENV: test
        run: |
          # Run ONLY database tests (marked with @pytest.mark.database)
          pytest -v -m database tests/test_database_integration.py

      - name: Verify database secrets are configured
        if: failure()
        run: |
          echo "❌ Database tests failed!"
          echo ""
          echo "Please ensure GitHub secret is configured:"
          echo "  - OC5_DATABASE_URL (Supabase direct connection URL)"
          echo ""
          echo "Format: postgresql+asyncpg://USER:PASS@HOST:5432/postgres"
          echo ""
          echo "Go to: Settings → Secrets and variables → Actions"
